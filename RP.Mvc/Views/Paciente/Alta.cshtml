

@using RP.Mvc.Models;
@{
    ViewBag.Title = "Alta de pacientes";
}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<h2>&nbsp;</h2>
<ol class="breadcrumb">
    <li><a href="#">Home</a></li>
    <li><a href="#">Paciente</a></li>
    <li class="active">@ViewBag.Title</li>
</ol>

<h2>@ViewBag.Title</h2>
<p>Desde este módulo puede dar de alta a los pacientes</p>

<div class="row">
    <div class="col-lg-4">

        <div class="panel panel-primary">
            <div class="panel-heading">
                <i class="fa fa-bar-chart-o fa-fw"></i> Paciente
            </div>
            <div class="panel-body">
                <div class="col-md-12">
                    <h4 id="nombrePaciente"></h4>

                    <!--
                    <ul class="list-unstyled">
                        <li><strong>Fecha de nacimento:</strong> <span id="fechaNacimiento"></span></li>
                        <li><strong>Edad:</strong> <span id="edadPaciente"></span></li>
                        <li><strong>Nro. de Telefono:</strong> <span id="nroTelefonoPaciente"></span></li>
                        <li><strong>Email:</strong> <span id="emailPaciente"></span></li>
                    </ul>
                    -->
                </div>
                <div class="col-md-12">
                    <hr />
                </div>
                <div class="col-md-6">
                    <p>Historia Clínica</p>
                </div>
                <div class="col-md-6">
                    <p id="historiaPaciente"></p>
                </div>
                <div class="col-md-6">
                    <p>Fec. Nacimiento</p>
                </div>
                <div class="col-md-6">
                    <p id="fechaNacimiento"></p>
                </div>
                <div class="col-md-6">
                    <p>Edad</p>
                </div>
                <div class="col-md-6">
                    <p id="edadPaciente"></p>
                </div>
                <div class="col-md-6">
                    <p>Nro. de Telefono</p>
                </div>
                <div class="col-md-6">
                    <p id="nroTelefonoPaciente"></p>
                </div>
                <div class="col-md-6">
                    <p>Email</p>
                </div>
                <div class="col-md-6">
                    <p id="emailPaciente"></p>
                </div>
                <div class="col-sm-12">
                    <button type="button" class="btn btn-block btn-primary btn-xs">Buscar otro paciente</button>
                    <!--<button type="button" class="btn btn-secondary btn-xs">Buscar otro médico</button>-->
                </div>


            </div>
        </div>


        <div class="panel panel-default">
            <div class="panel-heading">
                <i class="fa fa-bar-chart-o fa-fw"></i> Diagnóstico
            </div>
            <div class="panel-body">
                <div class="col-md-12">
                    <select class="form-control input-sm" id="listDiagnosticos" onchange="showPlanTratamiento(this.value)">
                        <option value="0">Seleccione</option>
                    </select>
                </div>
                <div class="row-fluid">&nbsp;</div>
                <div class="col-md-4">
                    <p>Fecha</p>
                </div>
                <div class="col-md-8">
                    <p id="fechaDiagnostico">&nbsp;</p>
                </div>
                <div class="col-md-4">
                    <p>Médico</p>
                </div>
                <div class="col-md-8">
                    <p id="nombreMedico">&nbsp;</p>
                </div>

                <div class="col-md-4">
                    <p>Detalle</p>
                </div>
                <div class="col-md-8">
                    <p id="detalleDiagnostico">&nbsp;</p>
                </div>
                <input type="hidden" id="idPlanTratamiento" value="0">
            </div>
        </div>
    </div>


    <div class="col-lg-8">

        <div class="row hide" id="planTratamiento">

            <div class="col-md-6">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-bar-chart-o fa-fw"></i> Plan de tratamiento
                    </div>
                    <div>
                        <h4 id="nroSesionHeader"># de sesiones: </h4>
                    </div>
                    <div class="panel-body">
                        <canvas id="pie-chart" width="100%" height="100%"></canvas>
                    </div>
                </div>

            </div>
            <div class="col-md-6" id="seccionAmpliarTratamiento">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-bar-chart-o fa-fw"></i> Ampliar plan de tratamiento
                    </div>
                    <div class="panel-body">
                        <div class="col-md-12 col-sm-12 col-xs-12 form-group ">
                            <label for="nroSesiones"># de Sesiones a agregar</label>
                            <input type="number" min="6" max="30" value="1" class="form-control input-sm" id="nroSesiones">

                        </div>
                        <div class="col-md-12 col-sm-12 col-xs-12 form-group ">
                            <button type="button" class="btn btn-primary btn-xs btn-block" onclick="javascript:ampliarTratamiento(this);">Incrementar sesiones</button>
                        </div>
                    </div>
                </div>

            </div>


            <div class="col-md-6" id="seccionDarAlta">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-bar-chart-o fa-fw"></i> Dar de Alta
                    </div>
                    <div class="panel-body">
                        <div class="col-md-12">
                            <p>Recomendaciones</p>
                        </div>
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <textarea class="col-md-4 col-sm-4 col-xs-12 form-group " style="min-width: 100%" maxlength="500" id="detDiagnostico" rows="5"></textarea>
                        </div>
                        <div class="col-md-12 col-sm-12 col-xs-12 form-group ">
                            <button type="button" class="btn btn-primary btn-xs btn-block" onclick="javascript:guardarAlta(this);">Dar de alta</button>
                        </div>
                    </div>
                </div>

            </div>




        </div>
        </div>
    </div>
    @section Scripts {
        @Scripts.Render("~/bundles/jqueryval")

        <script type="text/javascript">

            var numDoc = 45858596;
            var idPaciente = 1;
            var apiURL = "http://localhost:53229/api/";

            $(document).ready(function () {
                $('.date-session').datepicker({
                    weekStart: 1,
                    format: 'dd/mm/yyyy',
                    autoclose: true
                }).on('changeDate', function (selected) {
                    date = new Date(selected.date.valueOf());
                    var objetoSelectHora = $(this).parent().parent().find(".select-hora");
                    var fecha = formatoFecha(date);
                    //cargarHoras(objetoSelectHora, fecha);
                    fechaSeleccionada = fecha;
                });
            });


            function obtenerPaciente(numDoc) {
                var urlBuscarPaciente = apiURL + "paciente/buscar/1/" + numDoc;
                $.ajax({
                    url: urlBuscarPaciente,
                    success: function (data) {
                        if (data == null) {
                            return;
                        }
                        $("#nombrePaciente").text(data.NOMBRE);
                        $("#historiaPaciente").text(data.cNroHistoriaClinica);
                        $("#fechaNacimiento").text(convertirFecha(data.dFechaNacimiento));
                        $("#edadPaciente").text(data.nEdad);
                        $("#emailPaciente").text(data.cEmail);
                        $("#nroTelefonoPaciente").text(data.cNroTelefono);
                        $("#idPaciente").text(data.cNroTelefono);
                    }
                });
            }

            obtenerPaciente(numDoc);

            var listaDiagnosticos = [];

            function loadDiagnosticos() {
                var urlDiagnosticos = apiURL + "gestionpaciente/buscarDiagnosticos/" + idPaciente;
                $.ajax({

                    url: urlDiagnosticos,
                    success: function (data) {

                        if (data.length > 0) {
                            $.each(data, function (i, item) {

                                jQuery("#listDiagnosticos").append(
                                    '<option value="' + item.nDiagnosticoId + '">' + item.cDetalleDiagnostico + '</option>'
                                );
                            });
                        }
                    }
                });
            }

            loadDiagnosticos();


            function showPlanTratamiento(idDiagnostico) {

                var urlDiagnostico = apiURL + "gestionpaciente/diagnostico/" + idDiagnostico;
                $.ajax({

                    url: urlDiagnostico,
                    success: function (data) {
                        console.log(data);
                        if (data == null) {
                            return;
                        }
                        $("#fechaDiagnostico").text(data.dFecha);
                        $("#detalleDiagnostico").text(data.cDetalleDiagnostico);
                        $("#nombreMedico").text(data.nombreMedico);
                        $("#nroSesionesHeader").text(data.nNroTerapias);

                    }
                });

                if (idDiagnostico != 0) {
                    $("#planTratamiento").removeClass("hide");
                    generatePieChart(idDiagnostico);
                }

                if (idDiagnostico == "0") {
                    $("#planTratamiento").addClass("hide");
                }
            }

            function generatePieChart(idDiagnostico) {

                var atendidos = 0;
                var pendientes = 0;
                var urlConsolidadoPlanTratamiento = apiURL + "gestionpaciente/consolidadoPlanTratamiento/" + idDiagnostico;
                $.ajax({
                    url: urlConsolidadoPlanTratamiento,
                    success: function(data) {
                        /*for (var i = 1; i <= $("#nroSesionesTot").val() ; i++) {
                            arrEvolucion.push(0);
                        }*/

                        if (data.length > 0) {

                            $.each(data, function(i, item) {
                                console.log(item);
                                if (item.cCalificacion != null)
                                    atendidos++;
                                else
                                    pendientes++;

                            });

                            $("#nroSesionHeader").append(atendidos + pendientes);

                            new Chart(document.getElementById("pie-chart"), {
                                type: 'pie',
                                data: {
                                    labels: ["Pendientes", "Atendidas"],
                                    datasets: [{
                                        label: "Population (millions)",
                                        backgroundColor: ["#3e95cd", "#3cba9f"],
                                        data: [pendientes, atendidos]
                                    }]
                                }
                            });


                            if (pendientes / atendidos < 0.75) {
                                ezBSAlert({
                                    messageText: "El paciente no cumplió con el porcentaje mínimo de asistencias",
                                    alertType: "danger"
                                });
                                
                                $("#seccionDarAlta").addClass("hide");
                            } else {
                                $("#seccionAmpliarTratamiento").addClass("hide");
                            }

                        }
                    }
                });
            }


            function ampliarTratamiento(idDetallePlanTratamiento, idCita) {

                ezBSAlert({
                    type: "confirm",
                    messageText: "¿Está seguro de incrementar las sesiones?",
                    alertType: "info"
                }).done(function (e) {
                    var nroSesiones = $("#nroSesiones").val();
                    var idPlanTratamiento = $("#idPlanTratamiento").val();

                    console.log("e: " + e);
                    if (e) {
                        var grabar = apiURL + "gestionpaciente/grabarAmpliacionPlanTratamiento";

                        var param = {
                            idPlanTratamiento: idPlanTratamiento,
                            nroSesiones: nroSesiones
                        };
                        console.log(param);
                        $.ajax({
                            url: grabar,
                            method: "POST",
                            data: param,
                            success: function (data) {
                                console.log(data);
                                ezBSAlert({
                                    messageText: "Se actualizó la ficha de evolución",
                                    alertType: "info"
                                });

                            },
                            complete: function (data) {
                                location.reload();
                            }
                        });
                    }

                });

            }



            Number.prototype.padLeft = function (base, chr) {
                var len = (String(base || 10).length - String(this).length) + 1;
                return len > 0 ? new Array(len).join(chr || '0') + this : this;
            }

            function formatoFecha(d) {
                dformat = [
                    (d.getMonth() + 1).padLeft(),
                    d.getDate().padLeft(),
                    d.getFullYear()
                ].join('-');
                return dformat;
            }

            //--------------------------------------------- UTILS -----------------------------------------------

            function convertirFecha(date) {
                if (typeof date == "string")
                    date = new Date(date);
                var day = (date.getDate() <= 9 ? "0" + date.getDate() : date.getDate());
                var month = (date.getMonth() + 1 <= 9 ? "0" + (date.getMonth() + 1) : (date.getMonth() + 1));
                var dateString = day + "/" + month + "/" + date.getFullYear();

                return dateString;
            }


        </script>
    }
